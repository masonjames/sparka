---
title: Image Generation
description: AI-powered image creation in your chat app
---

## Overview

Generate images directly in chat using AI models. Supports both generation from text prompts and iterative editing of existing images.

## Quick Start

Toggle in `lib/config.ts`:

```ts
integrations: {
  imageGeneration: true,
}
```

Configure the default image model:

```ts
models: {
  defaults: {
    image: "openai/gpt-image-1.5",
  },
}
```

## Modes

The tool operates in two modes based on context:

| Mode       | Trigger                                      | Behavior                        |
| ---------- | -------------------------------------------- | ------------------------------- |
| `generate` | Text prompt only                             | Creates new image from scratch  |
| `edit`     | Prompt + attachments or previous generation  | Uses existing images as input   |

Mode is determined automatically:

```ts
const mode = imageParts.length > 0 || lastGeneratedImage ? "edit" : "generate";
```

## Iterative Editing

Users can iterate on generated images without re-uploading. The system automatically tracks the last generated image in the conversation.

### How It Works

1. **Extraction**: Before each request, the chat agent scans recent messages for the last generated image:

```ts title="app/(chat)/api/chat/get-recent-generated-image.ts"
export function getRecentGeneratedImage(messages: ChatMessage[]) {
  const lastAssistantMessage = messages.findLast(
    (message) => message.role === "assistant"
  );

  for (const part of lastAssistantMessage?.parts ?? []) {
    if (
      part.type === "tool-generateImage" &&
      part.state === "output-available" &&
      part.output?.imageUrl
    ) {
      return { imageUrl: part.output.imageUrl, name: "previous" };
    }
  }
  return null;
}
```

2. **Injection**: The extracted image is passed to the tool factory:

```ts title="lib/ai/core-chat-agent.ts"
const lastGeneratedImage = getRecentGeneratedImage(messages);

const tools = getTools({
  // ...other params
  lastGeneratedImage,
});
```

3. **Edit mode**: When `lastGeneratedImage` exists, the tool fetches it and includes it as input:

```ts title="lib/ai/tools/generate-image.ts"
const inputImages = await collectEditImages({ imageParts, lastGeneratedImage });
promptInput = { text: prompt, images: inputImages };
```

### User Experience

- User: "Generate a sunset over mountains"
- AI: *generates image*
- User: "Add a lake in the foreground"
- AI: *edits previous image* (no re-upload needed)

## Image Sources

Edit mode combines images from multiple sources:

| Source               | Description                                |
| -------------------- | ------------------------------------------ |
| `lastGeneratedImage` | Most recent generated image in conversation |
| `attachments`        | User-uploaded images in current message    |

Both are fetched and passed to the model:

```ts
async function collectEditImages({ imageParts, lastGeneratedImage }) {
  return await Promise.all([
    ...(lastGeneratedImage ? [fetchImageBuffer(lastGeneratedImage.imageUrl)] : []),
    ...imageParts.map((p) => fetchImageBuffer(p.url)),
  ]);
}
```

## Architecture

Follows the [Tool Part](/patterns/tool-part) pattern:

```
lib/ai/tools/generate-image.ts â†’ components/part/generate-image.tsx
```

### Tool Output

```ts
return { imageUrl: result.url, prompt };
```

The generated image is uploaded to blob storage and the URL returned.

### UI States

| State               | Shows                          |
| ------------------- | ------------------------------ |
| `input-available`   | Skeleton + "Generating: {prompt}" |
| `output-available`  | Image + copy button + prompt   |

## Configuration

### Image Model

```ts title="lib/config.ts"
models: {
  defaults: {
    image: "openai/gpt-image-1.5",
  },
}
```

Image models use a separate `ImageModelId` type from chat models.

## Related

- [Tool Part Pattern](/patterns/tool-part) - How tools connect to UI
- [Models Configuration](/customization/models) - Model defaults
