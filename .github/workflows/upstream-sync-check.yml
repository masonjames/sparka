# Sparka Upstream Sync Check
# Monitors FranciscoMoretti/sparka for new commits and creates an issue when behind
name: Upstream Sync Check

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_issue:
        description: 'Create issue even if no new commits'
        required: false
        default: 'false'
        type: boolean

env:
  UPSTREAM_REPO: FranciscoMoretti/sparka
  UPSTREAM_BRANCH: main

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for upstream changes
        id: check
        run: |
          # Count commits in upstream not in our main
          COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }} 2>/dev/null || echo "0")
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT

          # Get the commit subjects
          if [ "$COMMITS_BEHIND" -gt 0 ]; then
            COMMIT_LOG=$(git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }} | head -20)
            echo "commit_log<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_LOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Get date of latest upstream commit
            LATEST_DATE=$(git log -1 --format=%cd --date=short upstream/${{ env.UPSTREAM_BRANCH }})
            echo "latest_date=$LATEST_DATE" >> $GITHUB_OUTPUT
          fi

          echo "Commits behind upstream: $COMMITS_BEHIND"

      - name: Check for existing issue
        id: existing
        if: steps.check.outputs.commits_behind != '0' || github.event.inputs.force_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existing = issues.data.find(issue =>
              issue.title.includes('Upstream sync needed')
            );

            if (existing) {
              console.log(`Found existing issue #${existing.number}`);
              return existing.number;
            }
            return null;

      - name: Create or update issue
        if: (steps.check.outputs.commits_behind != '0' || github.event.inputs.force_issue == 'true') && steps.existing.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const commitsBehind = '${{ steps.check.outputs.commits_behind }}';
            const commitLog = `${{ steps.check.outputs.commit_log }}`;
            const latestDate = '${{ steps.check.outputs.latest_date }}';

            const body = `## Upstream Sync Needed

            This fork is **${commitsBehind} commits** behind [${process.env.UPSTREAM_REPO}](https://github.com/${process.env.UPSTREAM_REPO}).

            **Latest upstream commit:** ${latestDate}

            ### Recent upstream commits:
            \`\`\`
            ${commitLog}
            \`\`\`

            ### Sync procedure:

            1. Follow the [Sparka Upstream Sync Runbook](https://github.com/masonjames/platform-infra/blob/main/docs/runbooks/workflows/sparka-upstream-sync.md)
            2. Key files to preserve during merge:
               - \`lib/entitlements/\` - Ghost/Stripe integration
               - \`lib/blob.ts\` - R2 storage
               - \`trpc/routers/entitlements.router.ts\`
               - Schema extensions in \`lib/db/schema.ts\`

            ### Quick commands:
            \`\`\`bash
            git fetch upstream
            git merge upstream/main
            # Resolve conflicts
            bun install
            bun test:types
            bun lint
            git push origin main
            \`\`\`

            ---
            *This issue was automatically created by the upstream-sync-check workflow.*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”„ Upstream sync needed: ${commitsBehind} commits behind`,
              body: body,
              labels: ['upstream-sync', 'maintenance']
            });

            console.log('Created upstream sync issue');

      - name: Update existing issue
        if: steps.check.outputs.commits_behind != '0' && steps.existing.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.existing.outputs.result }};
            const commitsBehind = '${{ steps.check.outputs.commits_behind }}';

            // Add a comment with updated status
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `**Status update:** Now ${commitsBehind} commits behind upstream.`
            });

            // Update the title
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              title: `ðŸ”„ Upstream sync needed: ${commitsBehind} commits behind`
            });

      - name: Trigger sync PR workflow
        if: steps.check.outputs.commits_behind != '0' && steps.existing.outputs.result == 'null'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering upstream-sync-pr workflow..."
          gh workflow run upstream-sync-pr.yml || echo "Could not trigger workflow (may not exist yet)"

      - name: Summary
        run: |
          echo "## Upstream Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.commits_behind }}" = "0" ]; then
            echo "âœ… Fork is up to date with upstream" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Fork is **${{ steps.check.outputs.commits_behind }}** commits behind upstream" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recent upstream commits:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.check.outputs.commit_log }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ Sync PR workflow triggered" >> $GITHUB_STEP_SUMMARY
          fi
